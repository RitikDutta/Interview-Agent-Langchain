<!-- agent_lang.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview Coach - In Session</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4A90E2;
            --secondary-color: #2D3748;
            --background-color: #F7FAFC;
            --card-background: #FFFFFF;
            --text-color: #4A5568;
            --green-light: #38A169;
            --red-button: #E53E3E;
            --card-shadow: 0 7px 25px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: var(--text-color);
        }
        .main-container {
            display: flex;
            gap: 24px;
            width: 95%;
            max-width: 1600px;
            height: 95vh;
        }
        
        #interview-window {
            flex: 3;
            display: flex;
            flex-direction: column;
            background: var(--secondary-color);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            overflow: hidden;
            position: relative;
        }
        #video-container {
            flex-grow: 1;
            position: relative;
            background: #222;
        }
        .video-frame {
            position: absolute;
            background-color: #1a1a1a;
            border-radius: 8px;
            overflow: hidden;
        }
        #user-frame {
            top: 0; bottom: 0; left: 0; right: 0; z-index: 1;
        }
        #user-webcam {
            width: 100%; height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        #interviewer-mini-frame {
            top: 20px; right: 20px;
            width: 240px; height: 180px;
            background-color: var(--secondary-color);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
            z-index: 2;
        }
        .interviewer-initial {
            font-size: 5rem; font-weight: 700;
            color: rgba(255, 255, 255, 0.6); user-select: none;
        }
        .interviewer-info {
            position: absolute; bottom: 10px; left: 10px;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            padding: 8px 12px; border-radius: 6px;
            display: inline-flex; align-items: center; gap: 8px;
            font-size: 0.9em;
        }
        .online-dot { width: 8px; height: 8px; background-color: var(--green-light); border-radius: 50%; }
        .interviewer-info span { color: white; font-weight: 500; }

        #question-overlay {
            position: absolute; bottom: 25px; left: 25px;
            right: 285px; /* Spacing from the small video frame */
            background: rgba(0,0,0,0.7); backdrop-filter: blur(15px);
            color: white; padding: 25px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 1.5rem; line-height: 1.5; display: none;
            align-items: center; gap: 20px; z-index: 3;
        }
        .tts-button {
            background: none; border: none; font-size: 2rem;
            cursor: pointer; color: rgba(255,255,255,0.7);
            transition: color 0.2s;
        }
        .tts-button:hover { color: white; }
        .tts-button.speaking { color: var(--green-light); }

        /* Controls Bar */
        #controls-bar {
            background: var(--card-background); padding: 15px;
            display: flex; justify-content: center; align-items: center;
            gap: 10px; border-top: 1px solid #E2E8F0;
        }
        #user-input {
            flex-grow: 1; border-radius: 20px;
            border: 1px solid #CBD5E0;
            padding: 10px 15px; font-size: 1rem;
            resize: none; /* Disable manual resizing */
        }
        .control-button {
            width: 44px; height: 44px; border-radius: 50%;
            border: 1px solid #CBD5E0; background-color: #fff;
            color: var(--text-color); cursor: pointer; font-size: 1.5rem;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        
        .control-button.recording {
            background-color: var(--red-button);
            color: white;
            border-color: var(--red-button);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(229, 62, 62, 0); }
            100% { box-shadow: 0 0 0 0 rgba(229, 62, 62, 0); }
        }
        
        /* Sidebar */
        #sidebar {
            flex: 1.2; display: flex; flex-direction: column;
            background: var(--card-background); border-radius: var(--border-radius);
            box-shadow: var(--card-shadow); overflow: hidden; padding: 25px;
        }
        #sidebar-content { overflow-y: auto; flex-grow: 1; }
        #process-log-container { padding-bottom: 20px; }
        #profile-section-container { border-top: 1px solid #E2E8F0; padding-top: 20px; }
        #sidebar h3 {
            margin-top: 0; color: var(--primary-color); padding-bottom: 10px;
            font-size: 1.2rem; border-bottom: 2px solid var(--primary-color); margin-bottom: 15px;
        }
        #profile-details h4 {
            color: #A0AEC0; font-size: 0.8rem;
            text-transform: uppercase; margin-bottom: 10px;
        }
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .tag { background-color: #E2E8F0; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; }
        
        #process-log { font-family: 'Courier New', monospace; font-size: 0.85rem; line-height: 1.6; }
        .log-item { padding-bottom: 8px; }
        .log-arrow { color: var(--primary-color); font-weight: bold; margin-right: 8px; }
        .log-text { color: var(--text-color); }
    </style>
</head>
<body>

<div class="main-container">
    <div id="interview-window">
        <div id="video-container">
            <div id="user-frame" class="video-frame">
                <video id="user-webcam" autoplay muted></video>
            </div>
            <div id="interviewer-mini-frame" class="video-frame">
                <div class="interviewer-initial">AI</div>
                <div class="interviewer-info">
                    <div class="online-dot"></div>
                    <span>AI Interview Coach</span>
                </div>
            </div>
            <div id="question-overlay" class="question-overlay">
                <button id="tts-button" class="tts-button" title="Read question aloud">ðŸ”Š</button>
                <p id="agent-question-text"></p>
            </div>
        </div>
        <div id="controls-bar">
            <textarea id="user-input" rows="1" placeholder="Type your response here or use the mic..." disabled></textarea>
            <button id="mic-button" class="control-button" title="Start Listening">ðŸŽ¤</button>
            <button id="camera-button" class="control-button" title="Toggle Camera">ðŸ“·</button>
            <button id="end-call-button" class="control-button" style="background-color: var(--red-button); color: white;" title="End Session">ðŸ“ž</button>
        </div>
    </div>
    
    <div id="sidebar">
        <div id="sidebar-content">
            <div id="process-log-container">
                <h3>Agent Process Log</h3>
                <div id="process-log"></div>
            </div>
            <div id="profile-section-container">
                <h3>Live Profile</h3>
                <div id="profile-details">
                    <p>Your profile insights will appear here...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const userId = `user-${Math.random().toString(36).substr(2, 9)}`;
    const threadId = `thread-${Math.random().toString(36).substr(2, 9)}`;

    // DOM Elements
    const userInput = document.getElementById('user-input');
    const profileDetails = document.getElementById('profile-details');
    const processLog = document.getElementById('process-log');
    const questionOverlay = document.getElementById('question-overlay');
    const agentQuestionText = document.getElementById('agent-question-text');
    const ttsButton = document.getElementById('tts-button');
    const cameraButton = document.getElementById('camera-button');
    const userWebcam = document.getElementById('user-webcam');
    
    const synth = window.speechSynthesis;
    let targetVoice = null;
    function loadVoices() { if ('speechSynthesis' in window) { const voices = synth.getVoices(); targetVoice = voices.find(v => v.name === 'Google US English') || voices[0]; } }
    if ('speechSynthesis' in window) { synth.onvoiceschanged = loadVoices; loadVoices(); }
    function speakText(text) { if (!text || !('speechSynthesis'in window)) return; if (synth.speaking) { synth.cancel(); return; } const u = new SpeechSynthesisUtterance(text); u.voice = targetVoice; u.rate = 0.9; u.pitch = 1.0; u.onstart = () => { ttsButton.textContent = 'â¹ï¸'; ttsButton.classList.add('speaking'); }; u.onend = () => { ttsButton.textContent = 'ðŸ”Š'; ttsButton.classList.remove('speaking'); }; synth.speak(u); }

    let webcamStream;
    async function setupWebcam() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            try {
                webcamStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                userWebcam.srcObject = webcamStream;
            } catch (err) { console.error("Error accessing webcam:", err); userWebcam.style.backgroundColor = '#333'; }
        }
    }
    cameraButton.addEventListener('click', () => {
        if (webcamStream) {
            const track = webcamStream.getTracks()[0];
            track.enabled = !track.enabled;
            cameraButton.textContent = track.enabled ? 'ðŸ“·' : 'ðŸš«';
        }
    });

    function displayQA(question) {
        if (synth) synth.cancel();
        agentQuestionText.textContent = question;
        questionOverlay.style.display = 'flex';
    }

    async function updateProfileDashboard() {
        try {
            const response = await fetch(`/get_profile?user_id=${userId}`);
            const profile = await response.json();
            let html = '';
            if (profile.user_name) html += `<div><h4>Name</h4><div class="tag-container"><div class="tag">${profile.user_name}</div></div></div>`;
            if (profile.domain) html += `<div><h4>Domain</h4><div class="tag-container"><div class="tag">${profile.domain}</div></div></div>`;
            if (profile.technical_skills?.length) {
                html += `<div><h4>Technical Skills</h4><div class="tag-container">${profile.technical_skills.map(s => `<div class="tag">${s}</div>`).join('')}</div></div>`;
            }
            if (profile.strengths?.length) {
                html += `<div><h4>Strengths</h4><div class="tag-container">${profile.strengths.map(s => `<div class="tag" style="background-color: #C6F6D5;">${s}</div>`).join('')}</div></div>`;
            }
            profileDetails.innerHTML = html || '<p>Your profile insights will appear here...</p>';
        } catch (error) { console.error('Error fetching profile:', error); }
    }

    async function sendMessage(messageText) {
        userInput.disabled = true;
        processLog.innerHTML = '';
        questionOverlay.style.display = 'none';

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, thread_id: threadId, message: messageText }),
            });
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                const chunk = decoder.decode(value);
                const lines = chunk.split('\n\n').filter(line => line.trim() !== '');
                for (const line of lines) {
                    if (line.startsWith('data: ')) {
                        const event = JSON.parse(line.substring(6));
                        if (event.type === 'status') {
                            const logItem = document.createElement('div');
                            logItem.className = 'log-item';
                            logItem.innerHTML = `<span class="log-arrow">â†’</span> <span class="log-text">${event.content}</span>`;
                            processLog.appendChild(logItem);
                            processLog.scrollTop = processLog.scrollHeight;
                        } else if (event.type === 'final_response') {
                            displayQA(event.content);
                            await updateProfileDashboard();
                        } else if (event.type === 'error') {
                            displayQA('Sorry, an error occurred.');
                        }
                    }
                }
            }
        } catch (error) {
            console.error('Error:', error);
            displayQA('Sorry, a connection error occurred.');
        } finally {
            userInput.disabled = false;
            userInput.focus();
        }
    }

    userInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (synth) synth.cancel();
            sendMessage(userInput.value);
            userInput.value = '';
        }
    });
    ttsButton.addEventListener('click', () => speakText(agentQuestionText.textContent));

    window.addEventListener('load', () => {
        setupWebcam();
        sendMessage('<BEGIN_INTERVIEW>');
    });
</script>

<!-- speech recognition -->
<script>
    const micButton = document.getElementById("mic-button");
    const textarea = document.getElementById("user-input");
    
    // Check for browser support
    const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
    
    if (SpeechRecognition) {
        const recognizer = new SpeechRecognition();
        recognizer.lang = "en-US";
        recognizer.continuous = true;
        recognizer.interimResults = true;

        let isRecording = false;
        let finalTranscript = "";

        micButton.addEventListener("click", function() {
            if (!isRecording) {
                finalTranscript = textarea.value; // Start with existing text
                recognizer.start();
            } else {
                recognizer.stop();
            }
        });

        recognizer.onstart = () => {
            isRecording = true;
            micButton.classList.add("recording");
            micButton.title = "Stop Listening";
        };

        recognizer.onend = () => {
            isRecording = false;
            micButton.classList.remove("recording");
            micButton.title = "Start Listening";
            // Add a space if there's content, to separate future dictations
            if (finalTranscript.trim().length > 0) {
                finalTranscript += " ";
            }
            textarea.value = finalTranscript;
        };

        recognizer.onresult = function(event) {
            let interimTranscript = "";
            for (let i = event.resultIndex; i < event.results.length; i++) {
                let transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }
            textarea.value = finalTranscript + interimTranscript;
            // scroll with the text
            textarea.scrollTop = textarea.scrollHeight;
        };

        recognizer.onerror = function(event) {
            console.error("Speech recognition error", event.error);
            isRecording = false;
            micButton.classList.remove("recording");
        };
    } else {
        console.warn("Speech Recognition not supported by this browser.");
        micButton.style.display = 'none'; 
    }
</script>

</body>
</html>